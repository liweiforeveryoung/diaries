# OPA å…¥é—¨
## Introduction

The Open Policy Agent (OPAï¼Œå‘éŸ³ä¸ºâ€œOH-PAâ€ï¼‰æ˜¯ä¸€ä¸ªå¼€æºçš„é€šç”¨ç­–ç•¥å¼•æ“ï¼ŒOPA æä¾›äº†ä¸€ç§ high-level çš„å£°æ˜å¼è¯­è¨€ï¼Œå¯ä»¥é€šè¿‡ä»£ç å’Œä¸€äº›ç®€å•çš„ api æ¥è¡¨ç¤ºç­–ç•¥ï¼Œä»è€Œå°† policy decision çš„é€»è¾‘è§£è€¦å‡ºæ¥ã€‚ä½ å¯ä»¥åˆ©ç”¨ OPA åœ¨å¾®æœåŠ¡, K8S,  CI/CD ç®¡çº¿, API ç½‘å…³ç­‰é‡Œé¢æ‰§è¡Œç­–ç•¥ã€‚

## Overview

OPA å°† policy çš„ decision ä¸ policy çš„ enforcement è§£è€¦ã€‚

policy decision (ç­–ç•¥å†³è®®) : åˆ¤æ–­æŸä¸ªè§’è‰²æ˜¯å¦æœ‰æƒé™æ‰§è¡Œ policyã€‚

policy enforcement (ç­–ç•¥æ‰§è¡Œ): æ‰§è¡Œ policy çš„å…·ä½“å†…å®¹ã€‚

å½“ä½ çš„è½¯ä»¶éœ€è¦åš policy decision æ—¶ï¼Œå¯ä»¥æºå¸¦ä¸€äº› structured data (ä¾‹å¦‚ JSON ) å»æŸ¥è¯¢ OPAï¼ŒOPA æ¥æ”¶ä»»æ„çš„ structured dataã€‚

![img](21.assets/opa-service.svg)



<center>Policy Decoupling</center>

OPA å°†ä¼šç»“åˆ `Query`, `Policy`, `Data` è¿›è¡Œè¯„ä¼°å¹¶ç”Ÿæˆæœ€ç»ˆçš„ Policy Decisionã€‚OPA å’Œ Rego æ˜¯ domain-agnostic (é¢†åŸŸæ— å…³çš„) ã€‚æ‰€ä»¥ä½ å¯ä»¥åœ¨ Policy ä¸­æè¿°å‡ ä¹ä»»ä½•ç±»å‹çš„ invariant (ä¸å˜æ€§)ã€‚ä¾‹å¦‚: 

- Which users can access which resources.
- Which subnets egress traffic is allowed to.
- Which clusters a workload must be deployed to.
- Which registries binaries can be downloaded from.
- Which OS capabilities a container can execute with.
- Which times of day the system can be accessed at.

## Example

å‡è®¾æ‚¨ä¸ºä¸€ä¸ªå…·æœ‰ä»¥ä¸‹ç³»ç»Ÿçš„ç»„ç»‡å·¥ä½œ

![img](21.assets/system.svg)

<center>Example System</center>

åœ¨è¿™ä¸ªç³»ç»Ÿä¸­æœ‰ä¸‰ä¸ªç»„ä»¶

- Servers expose zero or more protocols (e.g., `http`, `ssh`, etc.)
- Networks connect servers and can be public or private. Public networks are connected to the Internet.
- Ports attach servers to networks.

æ‰€æœ‰çš„ servers, networks, and ports éƒ½é€šè¿‡ä¸€ä¸ªè„šæœ¬é…ç½®. è„šæœ¬æ¥æ”¶ä¸€ä¸ªå¯ä»¥è¡¨ç¤ºè¿™ä¸ªç³»ç»Ÿçš„  JSON å¯¹è±¡ä½œä¸ºè¾“å…¥ã€‚

å¦‚ä¸‹ï¼Œå°±æ˜¯ä¸€ä¸ªå¯ä»¥ç”¨æ¥è¡¨ç¤ºå½“å‰ç³»ç»Ÿçš„ JSON

```json
{
    "servers": [
        {"id": "app", "protocols": ["https", "ssh"], "ports": ["p1", "p2", "p3"]},
        {"id": "db", "protocols": ["mysql"], "ports": ["p3"]},
        {"id": "cache", "protocols": ["memcache"], "ports": ["p3"]},
        {"id": "ci", "protocols": ["http"], "ports": ["p1", "p2"]},
        {"id": "busybox", "protocols": ["telnet"], "ports": ["p1"]}
    ],
    "networks": [
        {"id": "net1", "public": false},
        {"id": "net2", "public": false},
        {"id": "net3", "public": true},
        {"id": "net4", "public": true}
    ],
    "ports": [
        {"id": "p1", "network": "net1"},
        {"id": "p2", "network": "net3"},
        {"id": "p3", "network": "net2"}
    ]
}
```

æŸä¸€å¤©æ—©ä¸Šï¼Œä½ çš„è€æ¿ç»™ä½ ä»‹ç»äº†æœ€æ–°çš„å®‰å…¨ç­–ç•¥ï¼Œå¹¶è¦æ±‚ä½ å»æ‰§è¡Œå®ƒã€‚

```
1. Servers reachable from the Internet must not expose the insecure 'http' protocol.
2. Servers are not allowed to expose the 'telnet' protocol.
```

æ¯å½“éœ€è¦é…ç½® servers, networks, and ports æ—¶éƒ½éœ€è¦æ‰§è¡Œè¿™ä¸ªç­–ç•¥ï¼Œå¹¶ä¸”å®‰å…¨å›¢é˜Ÿä¼šå®šæœŸå¯¹ç³»ç»Ÿè¿›è¡Œå®¡æ ¸ï¼Œæ‰¾åˆ°è¿èƒŒäº†å®‰å…¨è§„åˆ™çš„ Serverã€‚

ä½ çš„è€æ¿è®©ä½ æ¥å†³å®šæ˜¯å¦ä½¿ç”¨ OPA æ¥å®ç°è¿™ä¸ª policyã€‚

> PS: è¿™é‡Œå°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ policy decision ä¸ policy enforcement æ··åˆçš„æƒ…å†µã€‚
>
> policy enforcement æ˜¯ç”±è„šæœ¬å»æ‰§è¡Œçš„ï¼Œæœ€åˆè„šæœ¬ä¼šå¯¹æ‰€æœ‰çš„é…ç½®æ–‡ä»¶éƒ½æŒæ¬¢è¿æ€åº¦ã€‚ä½†ç°åœ¨ä¸–ä»£å˜äº†ï¼Œæœ‰äº›ä¸åˆæ³•çš„é…ç½®æ–‡ä»¶ä¸åº”è¯¥è¢«æ‰§è¡Œã€‚
>
> è€Œåˆ¤æ–­é…ç½®æ˜¯å¦åˆæ³•ï¼Œåˆ™å°±æ˜¯ policy decision çš„ä»»åŠ¡çš„ã€‚å½“æ²¡æœ‰ OPA æ—¶ï¼Œè„šæœ¬æ¯æ¬¡æ¥æ”¶è¾“å…¥æ—¶ï¼Œéƒ½å¿…é¡»è‡ªå·±åˆ¤æ–­è¯¥é…ç½®æ˜¯å¦åˆæ³•ã€‚ä½†ç°åœ¨å¯ä»¥ç”± OPA å»åˆ¤æ–­é…ç½®åˆæ³•ä¸å¦äº†ã€‚å³ policy decision å’Œ policy enforcement è§£è€¦äº†ã€‚policy decision ç”± OPA è´Ÿè´£ï¼Œpolicy enforcement åˆ™ä¾æ—§ç”±åŸæ¥çš„è„šæœ¬è´Ÿè´£ã€‚

## Rego

Rego æ˜¯ä¸€ç§ç”¨æ¥çš„è¡¨ç¤ºOPAç­–ç•¥çš„é«˜çº§å£°æ˜è¯­è¨€ã€‚

### References

è¾“å…¥çš„æ•°æ®å°†ä¼šè¢«ç»‘å®šåˆ°ä¸€ä¸ªåä¸º `input` çš„å˜é‡ä¸Šã€‚å¯ä»¥é€šè¿‡ `.`æ¥å› ä¸ºè¾“å…¥çš„æ•°æ®ã€‚

ä¾‹å¦‚

```
input.servers
input.servers[0].protocols[0]
```

å¦‚æœä½ å¼•ç”¨çš„å€¼ä¸å­˜åœ¨ï¼Œ OPA å°†ä¼šè¿”å› *undefined*. Undefined æ„å‘³ç€ OPA æ— æ³•æ‰¾åˆ°ä»»ä½•ç»“æœ

### Variables

å¯ä»¥åˆ©ç”¨ `:=` ç»™å˜é‡èµ‹å€¼	

```
s := input.servers[0]
s.id == "app"
p := s.protocols[0]
p == "https"
```

æ˜¯ `some` æ¥å£°æ˜ä¸€ä¸‹å˜é‡

```
some i
```

### Rules

Rego å…è®¸æ‚¨ä½¿ç”¨ rule å°è£…å¹¶é‡æ–°ä½¿ç”¨é€»è¾‘ã€‚rule åªæ˜¯ if-then é€»è¾‘è¯­å¥ã€‚rule åˆ†ä¸ºä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯ complete å’Œ partial

rule çš„ç»“æ„å¦‚ä¸‹

```
variable = value {
	condition1
  condition2
}
```

è¡¨ç¤ºå°† `{}`é‡Œé¢çš„ condition éƒ½æ»¡è¶³æ—¶ï¼Œvariable çš„å€¼å°†ä¼šæ˜¯ valueã€‚

`{}` é‡Œé¢çš„å¤šä¸ª condition ä¹‹é—´æ˜¯ && å…³ç³»ã€‚

`variable = value` ç§°ä¸º head, `{}`çš„å†…å®¹ç§°ä¸º body

`= value` 	éƒ¨åˆ†å¯ä»¥çœç•¥, ä¼šè¢«è§†ä¸º `= true` æ¥å¤„ç†

```
variable {                  
	condition1               
  condition2                  
}                   
```

`{}`äº¦å¯ä»¥è¢«å¿½ç•¥ï¼Œä¼šè¢«è§†ä¸º`{}`çš„æ¡ä»¶éƒ½æ˜¯æ»¡è¶³çš„

```
variable = value
```

#### Complete Rules

Complete Rules æ˜¯if-then-then çš„è¯­å¥ï¼Œå®ƒä»…å°†å•ä¸ªå€¼èµ‹å€¼ç»™å˜é‡ã€‚ä¾‹å¦‚ï¼š

```
package example.rules

any_public_networks = true {  # is true if...
    net := input.networks[_]  # some network exists and..
    net.public                # it is public.
}
```

æ‰€æœ‰ç”± rule çš„å€¼éƒ½å¯ä»¥é€šè¿‡ä¸€ä¸ªå…¨å±€çš„å˜é‡ `data` æ¥å¼•ç”¨

```
data.example.rules.any_public_networks
```

> ğŸ’¡ You can query the value of any rule loaded into OPA by referring to it with an absolute path. The path of a rule is always: `data.<package-path>.<rule-name>`.

å¦‚æœ OPA æ‰¾ä¸åˆ°å¯ä»¥æ»¡è¶³ rule body çš„å˜é‡ï¼Œrule çš„å€¼å°†ä¼šæ˜¯ undefined çš„ã€‚

#### Partial Rules

Partial rules åŒæ ·æ˜¯ if-then è¯­è¨€ï¼Œä¸è¿‡å®ƒä¼šå°†å¤šä¸ªå€¼èµ‹å€¼ç»™å˜é‡ã€‚ä¾‹å¦‚

```
package example.rules

public_network[net.id] {      # net.id is in the public_network set if...
    net := input.networks[_]  # some network exists and...
    net.public                # it is public.
}
```

```
public_network

[
  "net3",
  "net4"
]
```

#### Logical OR

 è¦åœ¨Regoä¸­è¡¨ç¤º Logical ORï¼Œéœ€è¦å®šä¹‰å¤šä¸ªå…·æœ‰ç›¸åŒåç§°çš„ ruleã€‚

```
package example.logical_or

default shell_accessible = false

shell_accessible = true {
    input.servers[_].protocols[_] == "telnet"
}

shell_accessible = true {
    input.servers[_].protocols[_] == "ssh"
}
```

> ğŸ’¡ The `default` keyword tells OPA to assign a value to the variable if all of the other rules with the same name are undefined.

### Putting It Together

ä¸Šé¢å°±æ˜¯ Rego æ‰€æœ‰çš„æ ¸å¿ƒæ€æƒ³äº†ã€‚å›é¡¾ä¸€ä¸‹ä¹‹å‰çš„ç›®æ ‡ï¼Œè®©æˆ‘ä»¬æŠŠä¸Šé¢çš„çŸ¥è¯†ç»“åˆåˆ°ä¸€èµ·æ¥å®ç°å®ƒã€‚

```
1. Servers reachable from the Internet must not expose the insecure 'http' protocol.
2. Servers are not allowed to expose the 'telnet' protocol.
```

```
package example

allow = true {                                      # allow is true if...
    count(violation) == 0                           # there are zero violations.
}

violation[server.id] {                              # a server is in the violation set if...
    some server
    public_server[server]                           # it exists in the 'public_server' set and...
    server.protocols[_] == "http"                   # it contains the insecure "http" protocol.
}

violation[server.id] {                              # a server is in the violation set if...
    server := input.servers[_]                      # it exists in the input.servers collection and...
    server.protocols[_] == "telnet"                 # it contains the "telnet" protocol.
}

public_server[server] {                             # a server exists in the public_server set if...
    some i, j
    server := input.servers[_]                      # it exists in the input.servers collection and...
    server.ports[_] == input.ports[i].id            # it references a port in the input.ports collection and...
    input.ports[i].network == input.networks[j].id  # the port references a network in the input.networks collection and...
    input.networks[j].public                        # the network is public.
}
```

```
some x; violation[x]

+-----------+--------------+
|     x     | violation[x] |
+-----------+--------------+
| "ci"      | "ci"         |
| "busybox" | "busybox"    |
+-----------+--------------+
```

### Built-in Functions

https://www.openpolicyagent.org/docs/latest/policy-reference/#built-in-functions

## å®‰è£…æ•™ç¨‹

https://www.openpolicyagent.org/docs/latest/#running-opa

## å‚è€ƒé“¾æ¥

https://www.openpolicyagent.org/docs/latest/

