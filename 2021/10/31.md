# KIND and Load Balancing with MetalLB on Mac

åœ¨ Mac ä¸Šï¼Œç”±äº host å’Œ docker bridge ç½‘ç»œä¹‹é—´å¹¶ä¸æ˜¯é€šçš„ï¼Œå› æ­¤å½“ Service ç±»å‹ä¸º Load Balance æ—¶ï¼Œå¤–éƒ¨çš„è¯·æ±‚å¹¶ä¸èƒ½å‘½ä¸­åˆ° Docker bridge ç½‘ç»œä¸Šï¼Œä»è€Œå¯¼è‡´è¯·æ±‚å¤±è´¥ã€‚è¿™ä¸ªé—®é¢˜æŠ˜ç£¨äº†æˆ‘å¥½ä¹…ï¼Œæœ€ç»ˆä»è¿™ç¯‡[æ–‡ç« ](https://www.thehumblelab.com/kind-and-metallb-on-mac/)ä¸Šæ‰¾åˆ°äº†è§£å†³åŠæ³•ã€‚

è§£å†³è¿™ä¸ªé—®é¢˜çš„å…³é”®ï¼Œåœ¨äºå¦‚ä½•æŠŠå¤–éƒ¨çš„æµé‡æ‰“åˆ° docker çš„ bridge ç½‘ç»œä¸Šã€‚è¿™é‡Œä½¿ç”¨äº†ä¸€ä¸ªå¼€æºçš„ä»“åº“[docker-tuntap-osx](https://github.com/AlmirKadric-Published/docker-tuntap-osx)ï¼Œå®ƒæ˜¯ä¸€ä¸ªè„šæœ¬ï¼Œæ‰§è¡Œè¿™ä¸ªè„šæœ¬ä¹‹åï¼Œä¼šåœ¨ mac ä¸Šå»ºç«‹ä¸€å¼ ç½‘å¡ï¼Œè¿™ä¸ªç½‘å¡å’Œ docker ä¹‹é—´çš„ç½‘ç»œæ˜¯é€šçš„ï¼Œæ¥ä¸‹æ¥åªéœ€è¦æ·»åŠ è·¯ç”±ï¼ŒæŠŠéœ€è¦è·¯ç”±åˆ° docker bridge ç½‘ç»œçš„è¯·æ±‚éƒ½ route åˆ°è¿™ä¸ªç½‘å¡ä¸Šï¼Œé€šè¿‡è¿™ä¸ªç½‘å¡å°†è¯·æ±‚è½¬å‘åˆ° docker bridge network ä¸Šã€‚

[docker-tuntap-osx](https://github.com/AlmirKadric-Published/docker-tuntap-osx)è¿™ä¸ªè„šæœ¬ä¾èµ–[TunTap](http://tuntaposx.sourceforge.net/)è¿™ä¸ªå·¥å…·ï¼Œå› æ­¤ç¬¬ä¸€æ­¥æ˜¯å®‰è£… [TunTap](http://tuntaposx.sourceforge.net/)ã€‚å½“ç„¶ï¼Œåœ¨æ­¤ä¹‹å‰ï¼Œä½ éœ€è¦å®‰è£… KIND å’Œ Dockerã€‚

## Install KIND and Docker

KIND åœ°å€: https://kind.sigs.k8s.io/

Docker åœ°å€: https://www.docker.com/

å®‰è£…è¿‡ç¨‹: ç•¥

æˆ‘ç”µè„‘ä¸Šçš„ KIND ç‰ˆæœ¬ä»¥åŠ Docker ç‰ˆæœ¬åˆ†åˆ«ä¸º

```shell
âœ  kind-metallb kind --version
kind version 0.11.1
âœ  kind-metallb docker --version
Docker version 20.10.8, build 3967b7d
```

## Install TunTap

æˆ‘çš„ Mac ä¸Š Homebrew çš„ç‰ˆæœ¬å¦‚ä¸‹

```shell
âœ  kind-metallb brew --version
Homebrew 3.2.15
```

å½“å‰çš„ç³»ç»Ÿç‰ˆæœ¬

```shell
âœ  kind-metallb uname -a
Darwin helloworld 19.6.0 Darwin Kernel Version 19.6.0: Tue Jun 22 19:49:55 PDT 2021; root:xnu-6153.141.35~1/RELEASE_X86_64 x86_64
```

å¯ä»¥ç›´æ¥é€šè¿‡ brew å‘½ä»¤æ¥å®‰è£… TunTap

```shell
brew install --cask tuntap
```

åœ¨å®‰è£…çš„è¿‡ç¨‹ä¸­éœ€è¦è¾“å…¥å¯†ç ã€‚

ä½†è¾“å…¥å¯†ç åä¾ç„¶å®‰è£…å¤±è´¥äº†ã€‚åŸå› æ˜¯æ²¡æœ‰ç»™æƒé™ã€‚

æ‰“å¼€

```
ç³»ç»Ÿåå¥½è®¾ç½® -> å®‰å…¨æ€§ä¸éšç§ -> é€šç”¨
```

ç»™ `å…è®¸ Mattias Nissler XXX ` æ‰“ä¸Šå‹¾ã€‚ï¼ˆMattias Nissler æ˜¯ Tuntap è¿™ä¸ªå·¥å…·çš„ä½œè€…)

é€€å‡º `Docker Desktop For Mac` é‡æ–°æ‰§è¡Œä¸€æ¬¡å‘½ä»¤ã€‚

```shell
brew install --cask tuntap
```

ç»“æœä¾æ—§å®‰è£…å¤±è´¥ã€‚

æœ€åé‡å¯äº†ä¸€ä¸‹ç”µè„‘ï¼Œå†æ¬¡å®‰è£…ï¼Œè¿™æ¬¡ç»ˆäºå®‰è£…æˆåŠŸäº†ã€‚

## Install tap

æ¥ä¸‹æ¥å°±éœ€è¦åˆ©ç”¨ tuntap è¿™ä¸ªå·¥å…·æ¥ç»™åˆ›å»ºç½‘å¡äº†

æŠŠ [docker-tuntap-osx](https://github.com/AlmirKadric-Published/docker-tuntap-osx) clone ä¸‹æ¥

```shell
git clone git@github.com:AlmirKadric-Published/docker-tuntap-osx.git
```

ä¾æ¬¡æ‰§è¡Œè¿™ä¸¤ä¸ª shell è„šæœ¬å°±è¡Œäº†

```shell
./docker-tuntap-osx/sbin/docker_tap_install.sh
./docker-tuntap-osx/sbin/docker_tap_up.sh
```

æ¥ç€æ£€æŸ¥æ˜¯å¦æˆåŠŸäº†ï¼Œæ‰§è¡Œ ifconfig å‘½ä»¤ï¼Œæ‹–åˆ°æœ€ä¸‹é¢

```
tap1: flags=8843<UP,BROADCAST,RUNNING,SIMPLEX,MULTICAST> mtu 1500
	ether 8a:4e:85:69:a2:bf
	inet 10.0.75.1 netmask 0xfffffffc broadcast 10.0.75.3
	media: autoselect
	status: active
	open (pid 2309)
```

ä¼šçœ‹åˆ°å¢åŠ äº†ä¸€ä¸ªåä¸º tap1 çš„ç½‘å¡ã€‚

## Add Route

æ¥ä¸‹æ¥éœ€è¦æŠŠ docker bridge çš„ ip æ®µéƒ½ route åˆ° tap1 è¿™å¼ ç½‘å¡ä¸Š

åˆ©ç”¨ `docker network ls` æŸ¥çœ‹ docker çš„ network æƒ…å†µ

```
âœ  kind-metallb docker network ls
NETWORK ID     NAME      DRIVER    SCOPE
a72136e0a128   bridge    bridge    local
0f4a261db133   host      host      local
6ca7c686aab0   kind      bridge    local
4e612adeacb8   none      null      local
```

è¿™é‡Œé¢æœ‰ä¸€ä¸ªåä¸º `kind` çš„ networkï¼Œè¿™ä¸ªnetwork å°±æ˜¯ KIND åˆ›å»ºçš„ã€‚

åˆ©ç”¨ `docker network inspect kind` çœ‹çœ‹ kind çš„ ip åŒºé—´

```json
âœ  kind-metallb docker network inspect kind
[
    {
        "Name": "kind",
        "IPAM": {
            "Driver": "default",
            "Config": [
                {
                    "Subnet": "172.18.0.0/16",
                    "Gateway": "172.18.0.1"
                },
                {
                    "Subnet": "fc00:f853:ccd:e793::/64",
                    "Gateway": "fc00:f853:ccd:e793::1"
                }
            ]
        },
    }
]

âœ  kind-metallb docker network inspect -f '{{.IPAM.Config}}' kind
[{172.18.0.0/16  172.18.0.1 map[]} {fc00:f853:ccd:e793::/64  fc00:f853:ccd:e793::1 map[]}]
```

ç€é‡è§‚å¯Ÿ `Subnet` çš„å€¼ï¼Œå¯ä»¥çœ‹åˆ° `172.18.0.0/16` è¢«åˆ†é…ç»™äº† kind

æŠŠ  `172.18.0.0/16`  è¿™æ®µ ip åŒºé—´å…¨éƒ½ route åˆ° tap1 ä¸Š

```shell
sudo route -v add -net 172.18.0.1 -netmask 255.255.0.0 10.0.75.2
```

éªŒè¯ä¸€ä¸‹æ˜¯å¦æ·»åŠ æˆåŠŸäº†

```shell
âœ  kind-metallb route get 172.18.0.1
   route to: 172.18.0.1
destination: 172.18.0.0
       mask: 255.255.0.0
    gateway: 10.0.75.2
  interface: tap1
      flags: <UP,GATEWAY,DONE,STATIC,PRCLONING>
 recvpipe  sendpipe  ssthresh  rtt,msec    rttvar  hopcount      mtu     expire
       0         0         0         0         0         0      1500         0
```

å¦‚ä¸Šï¼Œå¯¹ 172.18.0.1 çš„è¯·æ±‚ä¼šé€šè¿‡ tap1 ç½‘å¡è½¬å‘ã€‚

## Deploying an Application

ç°åœ¨ host å’Œ docker bridge network ä¹‹é—´é€šäº†ï¼Œæ¥ä¸‹æ¥å¯ä»¥æŒ‰ç…§[å®˜ç½‘æ–‡æ¡£](https://kind.sigs.k8s.io/docs/user/loadbalancer/)çš„æ•™ç¨‹æ¥éƒ¨ç½²åº”ç”¨äº†ã€‚

### Create Cluster

ç¬¬ä¸€æ­¥æ˜¯åˆ©ç”¨ KIND åˆ›å»ºä¸€ä¸ª k8s cluster

åœ¨è¿™é‡Œæˆ‘åˆ›å»ºä¸€ä¸ªåŒèŠ‚ç‚¹çš„ cluster

å¯¹åº”çš„ KIND é…ç½®æ–‡ä»¶ä¸º

```yaml
# config.yaml
kind: Cluster
apiVersion: kind.x-k8s.io/v1alpha4
nodes:
- role: control-plane
- role: worker
```

```
âœ  kind-metallb kind create cluster --config config.yaml
Creating cluster "kind" ...
 âœ“ Ensuring node image (kindest/node:v1.21.1) ğŸ–¼
 âœ“ Preparing nodes ğŸ“¦ ğŸ“¦
 âœ“ Writing configuration ğŸ“œ
 âœ“ Starting control-plane ğŸ•¹ï¸
 âœ“ Installing CNI ğŸ”Œ
 âœ“ Installing StorageClass ğŸ’¾
 âœ“ Joining worker nodes ğŸšœ
Set kubectl context to "kind-kind"
You can now use your cluster with:

kubectl cluster-info --context kind-kind

Have a question, bug, or feature request? Let us know! https://kind.sigs.k8s.io/#community ğŸ™‚
```

ps: å«Œ `kubectl` å¤ªé•¿, ç»™å®ƒå»ºäº†ä¸€ä¸ª alias:  alias kb="kubectl"

æŸ¥çœ‹ä¸€ä¸‹ cluster é‡Œçš„ node åœ°å€

```shell
âœ  kind-metallb kb get nodes -o wide
NAME                 STATUS   ROLES                  AGE     VERSION   INTERNAL-IP   EXTERNAL-IP   OS-IMAGE       KERNEL-VERSION     CONTAINER-RUNTIME
kind-control-plane   Ready    control-plane,master   4m13s   v1.21.1   172.18.0.3    <none>        Ubuntu 21.04   5.10.47-linuxkit   containerd://1.5.2
kind-worker          Ready    <none>                 3m52s   v1.21.1   172.18.0.2    <none>        Ubuntu 21.04   5.10.47-linuxkit   containerd://1.5.2
```

ping ä¸€ä¸‹ 172.18.0.2 å’Œ 172.18.0.3, çœ‹çœ‹èƒ½ä¸èƒ½ ping é€š

```
âœ  kind-metallb ping 172.18.0.2
PING 172.18.0.2 (172.18.0.2): 56 data bytes
64 bytes from 172.18.0.2: icmp_seq=0 ttl=63 time=0.838 ms
64 bytes from 172.18.0.2: icmp_seq=1 ttl=63 time=0.367 ms
^C
--- 172.18.0.2 ping statistics ---
2 packets transmitted, 2 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 0.367/0.603/0.838/0.235 ms
âœ  kind-metallb ping 172.18.0.3
PING 172.18.0.3 (172.18.0.3): 56 data bytes
64 bytes from 172.18.0.3: icmp_seq=0 ttl=63 time=0.555 ms
64 bytes from 172.18.0.3: icmp_seq=1 ttl=63 time=0.519 ms
^C
--- 172.18.0.3 ping statistics ---
2 packets transmitted, 2 packets received, 0.0% packet loss
round-trip min/avg/max/stddev = 0.519/0.537/0.555/0.018 ms
```

**<u>ä¸€å®šè¦ç¡®ä¿èƒ½ ping é€š</u>**ï¼Œå¦‚æœæ²¡æœ‰ ping é€šæ£€æŸ¥ä¸€ä¸‹å‰é¢æ­¥éª¤ï¼Œçœ‹çœ‹æ˜¯ä¸æ˜¯æ²¡æœ‰ add route, æˆ–è€…å®‰è£… tap1 å¤±è´¥äº†ã€‚

### Installing metallb using default manifests

ä¾æ¬¡æ‰§è¡Œ

```shell
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/master/manifests/namespace.yaml
kubectl create secret generic -n metallb-system memberlist --from-literal=secretkey="$(openssl rand -base64 128)" 
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/master/manifests/metallb.yaml
```

ç­‰å¾… metallb-system ä¸‹é¢çš„ pod å˜æˆ running çŠ¶æ€

```shell
âœ  kind-metallb kubectl get pods -n metallb-system --watch
NAME                          READY   STATUS              RESTARTS   AGE
controller-6cc57c4567-9fhhx   0/1     ContainerCreating   0          8s
speaker-86c62                 0/1     ContainerCreating   0          8s
speaker-m6rb8                 0/1     ContainerCreating   0          8s
speaker-86c62                 1/1     Running             0          19s
speaker-m6rb8                 1/1     Running             0          19s
controller-6cc57c4567-9fhhx   1/1     Running             0          31s
^C%
```

### Setup address pool used by loadbalancers

```shell
âœ  kind-metallb docker network inspect -f '{{.IPAM.Config}}' kind
[{172.18.0.0/16  172.18.0.1 map[]} {fc00:f853:ccd:e793::/64  fc00:f853:ccd:e793::1 map[]}]
```

ä» 172.18.0.0/16 ä¸­æ‘˜å‡ºä¸€æ®µ ip åŒºé—´ä½œä¸º loadbalancer çš„ ip æ± 

æˆ‘é€‰æ‹©äº† 172.18.0.150-172.18.0.200 è¿™æ®µåŒºé—´ï¼Œå¯¹åº”çš„ manifest æ–‡ä»¶ä¸º

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: metallb-system
  name: config
data:
  config: |
    address-pools:
    - name: default
      protocol: layer2
      addresses:
      - 172.18.0.150-172.18.0.200
```

apply it!

```shell
âœ  kind-metallb kubectl apply -f metallb-config.yaml
configmap/config created
```

## Using LoadBalancer

æ‰€æœ‰å‡†å¤‡å·¥ä½œéƒ½å°±ç»ªäº†ï¼Œæ¥ä¸‹æ¥å°±æ˜¯ä½¿ç”¨ LoadBalancer äº†

Pod å’Œ Service çš„ manifest å¦‚ä¸‹

```yaml
# usage.yaml
kind: Pod
apiVersion: v1
metadata:
  name: foo-app
  labels:
    app: http-echo
spec:
  containers:
  - name: foo-app
    image: hashicorp/http-echo:0.2.3
    args:
    - "-text=foo"
---
kind: Pod
apiVersion: v1
metadata:
  name: bar-app
  labels:
    app: http-echo
spec:
  containers:
  - name: bar-app
    image: hashicorp/http-echo:0.2.3
    args:
    - "-text=bar"
---
kind: Service
apiVersion: v1
metadata:
  name: foo-service
spec:
  type: LoadBalancer
  selector:
    app: http-echo
  ports:
  # Default port used by the image
  - port: 5678
```

apply it!

```
âœ  kind-metallb kb apply -f usage.yaml
pod/foo-app created
pod/bar-app created
service/foo-service created
```

```
âœ  kind-metallb kb get pods
NAME      READY   STATUS    RESTARTS   AGE
bar-app   1/1     Running   0          22s
foo-app   1/1     Running   0          22s
```

```
âœ  kind-metallb kb get svc
NAME          TYPE           CLUSTER-IP      EXTERNAL-IP    PORT(S)          AGE
foo-service   LoadBalancer   10.96.112.188   172.18.0.150   5678:31857/TCP   41s
kubernetes    ClusterIP      10.96.0.1       <none>         443/TCP          19m
```

å¯ä»¥çœ‹åˆ° LoadBlance çš„ ip ä¸º 172.18.0.150, port ä¸º 5678

curl ä¸€ä¸‹

```shell
âœ  kind-metallb for _ in $(seq 100);do curl 172.18.0.150:5678 && sleep 1;done
foo
bar
foo
foo
bar
bar
bar
bar
foo
```

å¦‚ä¸Š, foo å’Œ bar æ˜¯äº¤æ›¿å‡ºç°çš„ã€‚

(PS: å¦‚æœç”µè„‘å¼€äº† ssr ä»£ç†çš„è®°å¾—å…³æ‰ï¼Œæˆ‘å°±æ˜¯å› ä¸ºå¼€äº†ä»£ç†å¿˜è®°å…³æ‰ï¼Œå¯¼è‡´ curl ä¸€ç›´å¤±è´¥! æŠ˜ç£¨äº†æˆ‘èµ·ç åŠå¤©æ—¶é—´o(â•¥ï¹â•¥)o)

## å‚è€ƒé“¾æ¥

https://kind.sigs.k8s.io/docs/user/loadbalancer/

https://mauilion.dev/posts/kind-metallb/

https://www.thehumblelab.com/kind-and-metallb-on-mac/

